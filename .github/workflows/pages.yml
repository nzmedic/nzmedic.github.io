name: Build & Deploy Cockpit to Pages

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      lendy_loss_risk: ${{ steps.filter.outputs.lendy_loss_risk }}
      lendy_graduation_retention: ${{ steps.filter.outputs.lendy_graduation_retention }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed project paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            lendy_loss_risk:
              - 'projects/lendy-loss-risk/**'
              - 'cockpits/lendy-loss-risk/**'
              - 'cockpits/shared/**'
              - 'assets/**'
              - 'js/**'
            lendy_graduation_retention:
              - 'projects/lendy-graduation-retention/**'
              - 'cockpits/lendy-graduation-retention/**'
              - 'cockpits/shared/**'
              - 'assets/**'
              - 'js/**'

  build-projects:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: lendy-loss-risk
            changed_output: lendy_loss_risk
            requirements_file: projects/lendy-loss-risk/requirements.txt
            output_dir: projects/lendy-loss-risk/outputs
            site_output_dir: cockpits/lendy-loss-risk/outputs
            run_cmd: |
              python -m scripts.run_cockpit --scenario base
              python -m scripts.run_cockpit --scenario mild_stress
              python -m scripts.run_cockpit --scenario severe_stress
            working_dir: projects/lendy-loss-risk
          - id: lendy-graduation-retention
            changed_output: lendy_graduation_retention
            requirements_file: projects/lendy-graduation-retention/requirements.txt
            output_dir: cockpits/lendy-graduation-retention/outputs
            site_output_dir: cockpits/lendy-graduation-retention/outputs
            run_cmd: |
              ln -sfn lendy-graduation-retention projects/lendy_graduation_retention
              python -m projects.lendy_graduation_retention.pipeline
            working_dir: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Restore cached outputs
        id: cache-outputs
        uses: actions/cache@v4
        with:
          path: ${{ matrix.output_dir }}
          key: ${{ runner.os }}-${{ matrix.id }}-outputs-${{ hashFiles(matrix.requirements_file, format('projects/{0}/**', matrix.id)) }}

      - name: Decide whether to rebuild project outputs
        id: decision
        env:
          PROJECT_CHANGED: ${{ needs.detect-changes.outputs[matrix.changed_output] }}
          CACHE_HIT: ${{ steps.cache-outputs.outputs.cache-hit }}
        run: |
          if [ "$PROJECT_CHANGED" = "true" ] || [ "$CACHE_HIT" != "true" ]; then
            echo "rebuild=true" >> "$GITHUB_OUTPUT"
          else
            echo "rebuild=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        if: steps.decision.outputs.rebuild == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r "${{ matrix.requirements_file }}"

      - name: Build project outputs
        if: steps.decision.outputs.rebuild == 'true'
        working-directory: ${{ matrix.working_dir }}
        run: ${{ matrix.run_cmd }}

      - name: Stage outputs artifact
        run: |
          rm -rf artifact
          mkdir -p "artifact/${{ matrix.site_output_dir }}"
          cp -R "${{ matrix.output_dir }}/." "artifact/${{ matrix.site_output_dir }}/"

      - name: Upload project outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: outputs-${{ matrix.id }}
          path: artifact/
          if-no-files-found: error

  build-site:
    needs: build-projects
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download lendy-loss-risk outputs
        uses: actions/download-artifact@v4
        with:
          name: outputs-lendy-loss-risk
          path: .

      - name: Download lendy-graduation-retention outputs
        uses: actions/download-artifact@v4
        with:
          name: outputs-lendy-graduation-retention
          path: .

      - name: Build static site (_site)
        run: |
          rm -rf _site
          mkdir -p _site
          rsync -a ./ _site/ \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '_site' \
            --exclude '.venv' \
            --exclude 'artifact' \
            --exclude '**/__pycache__' \
            --exclude 'projects/**/outputs'

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    needs: build-site
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
